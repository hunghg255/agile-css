import _ from"node:path";import R from"jiti";import*as $ from"commander";import j from"http";import A from"node:fs";import O from"agile-css";import*as k from"globby";import*as P from"chokidar";function z(r,t=process.cwd()){const e=R(t,{interopDefault:!0,esmResolve:!0});try{return e(r)}catch(s){return s.code!=="MODULE_NOT_FOUND"&&console.error(`Error trying import ${r} from ${t}`,s),{}}}const E={black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m",console_color:"\x1B[0m"},y=(r,t)=>{const e=`${E[t]}${r}${E.console_color}`;return console.log(e)},V="agilecss";async function q(r=process.cwd(),t=process.argv){try{$.program.option("-p, --port <number>","port to listen on",parseInt).option("-w, --watch","watch for changes and reload").option("-c, --config <file_name>","File name config").parse(t);const e=$.program.opts(),s=e.port||4321,o=j.createServer(),i=e.config??V,c=_.resolve(r,i);let u=!1;const f=z(`./${i}.config`,c)||{};if(JSON.stringify(f)==="{}")throw new Error("Not Found Config");const{input:m,output:B,customValue:b,plugins:I=[],...D}=f(),d=m||"./srcTest",h=new O;h.setConfig(D),h.plugins(I),b&&h.customValue(b),h.on("success",l=>{A.writeFileSync(_.resolve(process.cwd(),B),l);const a=setTimeout(()=>{u=!0,clearTimeout(a)},1e3)}),h.on("valid",l=>{if(u&&e.watch){const{message:a,className:g}=l;y(`
\u2705 ${a} (class: ${g})`,"green")}}),h.on("invalid",l=>{const{message:a,className:g}=l;y(`
\u274C ${a} (class: ${g})`,"red")});const C=l=>{A.readFile(_.resolve(r,l),"utf8",(a,g)=>{if(a)throw a;h.find(g)})},T=l=>{for(let a=0;a<l.length;a++)C(l[a])},F=()=>{if(typeof d=="string"){const l=k.globbySync(d);T(l)}else if(Array.isArray(d))for(let l=0;l<d.length;l++){const a=d[l],g=k.globbySync(a);T(g)}},M=()=>{P.watch(m).on("change",C)};e.watch?o.listen(s,()=>{F(),M(),y(`\u{1F680} Agile CSS is running at port ${s}`,"yellow")}):F()}catch(e){y("\u274C Agile CSS Error: "+e.message,"red")}}const p={silent:Number.NEGATIVE_INFINITY,fatal:0,error:0,warn:1,log:2,info:3,success:3,fail:3,ready:3,start:3,debug:4,trace:5,verbose:Number.POSITIVE_INFINITY},N={silent:{level:-1},fatal:{level:p.fatal},error:{level:p.error},warn:{level:p.warn},log:{level:p.log},info:{level:p.info},success:{level:p.success},fail:{level:p.fail},ready:{level:p.info},start:{level:p.info},debug:{level:p.debug},trace:{level:p.trace},verbose:{level:p.verbose}};function w(r){return r!==null&&typeof r=="object"}function v(r,t,e=".",s){if(!w(t))return v(r,{},e,s);const o=Object.assign({},t);for(const i in r){if(i==="__proto__"||i==="constructor")continue;const c=r[i];c!=null&&(s&&s(o,i,c,e)||(Array.isArray(c)&&Array.isArray(o[i])?o[i]=[...c,...o[i]]:w(c)&&w(o[i])?o[i]=v(c,o[i],(e?`${e}.`:"")+i.toString(),s):o[i]=c))}return o}function J(r){return(...t)=>t.reduce((e,s)=>v(e,s,"",r),{})}const U=J();function Y(r){return Object.prototype.toString.call(r)==="[object Object]"}function G(r){return!(!Y(r)||!r.message&&!r.args||r.stack)}let L=!1;const x=[];class n{constructor(t={}){const e=t.types||N;this.options=U({...t,defaults:{...t.defaults},level:S(t.level,e),reporters:[...t.reporters||[]]},{types:N,throttle:1e3,throttleMin:5,formatOptions:{date:!0,colors:!1,compact:!0}});for(const s in e){const o={type:s,...this.options.defaults,...e[s]};this[s]=this._wrapLogFn(o),this[s].raw=this._wrapLogFn(o,!0)}this.options.mockFn&&this.mockTypes(),this._lastLog={}}get level(){return this.options.level}set level(t){this.options.level=S(t,this.options.types,this.options.level)}prompt(t,e){if(!this.options.prompt)throw new Error("prompt is not supported!");return this.options.prompt(t,e)}create(t){return new n({...this.options,...t})}withDefaults(t){return this.create({...this.options,defaults:{...this.options.defaults,...t}})}withTag(t){return this.withDefaults({tag:this.options.defaults.tag?this.options.defaults.tag+":"+t:t})}addReporter(t){return this.options.reporters.push(t),this}removeReporter(t){if(t){const e=this.options.reporters.indexOf(t);if(e>=0)return this.options.reporters.splice(e,1)}else this.options.reporters.splice(0);return this}setReporters(t){return this.options.reporters=Array.isArray(t)?t:[t],this}wrapAll(){this.wrapConsole(),this.wrapStd()}restoreAll(){this.restoreConsole(),this.restoreStd()}wrapConsole(){for(const t in this.options.types)console["__"+t]||(console["__"+t]=console[t]),console[t]=this[t].raw}restoreConsole(){for(const t in this.options.types)console["__"+t]&&(console[t]=console["__"+t],delete console["__"+t])}wrapStd(){this._wrapStream(this.options.stdout,"log"),this._wrapStream(this.options.stderr,"log")}_wrapStream(t,e){t&&(t.__write||(t.__write=t.write),t.write=s=>{this[e].raw(String(s).trim())})}restoreStd(){this._restoreStream(this.options.stdout),this._restoreStream(this.options.stderr)}_restoreStream(t){t&&t.__write&&(t.write=t.__write,delete t.__write)}pauseLogs(){L=!0}resumeLogs(){L=!1;const t=x.splice(0);for(const e of t)e[0]._logFn(e[1],e[2])}mockTypes(t){const e=t||this.options.mockFn;if(typeof e=="function")for(const s in this.options.types)this[s]=e(s,this.options.types[s])||this[s],this[s].raw=this[s]}_wrapLogFn(t,e){return(...s)=>{if(L){x.push([this,t,s,e]);return}return this._logFn(t,s,e)}}_logFn(t,e,s){if((t.level||0)>this.level)return!1;const o={date:new Date,args:[],...t,level:S(t.level,this.options.types)};!s&&e.length===1&&G(e[0])?Object.assign(o,e[0]):o.args=[...e],o.message&&(o.args.unshift(o.message),delete o.message),o.additional&&(Array.isArray(o.additional)||(o.additional=o.additional.split(`
`)),o.args.push(`
`+o.additional.join(`
`)),delete o.additional),o.type=typeof o.type=="string"?o.type.toLowerCase():"log",o.tag=typeof o.tag=="string"?o.tag.toLowerCase():"";const i=(u=!1)=>{const f=(this._lastLog.count||0)-this.options.throttleMin;if(this._lastLog.object&&f>0){const m=[...this._lastLog.object.args];f>1&&m.push(`(repeated ${f} times)`),this._log({...this._lastLog.object,args:m}),this._lastLog.count=1}u&&(this._lastLog.object=o,this._log(o))};clearTimeout(this._lastLog.timeout);const c=this._lastLog.time&&o.date?o.date.getTime()-this._lastLog.time.getTime():0;if(this._lastLog.time=o.date,c<this.options.throttle)try{const u=JSON.stringify([o.type,o.tag,o.args]),f=this._lastLog.serialized===u;if(this._lastLog.serialized=u,f&&(this._lastLog.count=(this._lastLog.count||0)+1,this._lastLog.count>this.options.throttleMin)){this._lastLog.timeout=setTimeout(i,this.options.throttle);return}}catch{}i(!0)}_log(t){for(const e of this.options.reporters)e.log(t,{options:this.options})}}function S(r,t={},e=3){return r===void 0?e:typeof r=="number"?r:t[r]&&t[r].level!==void 0?t[r].level:e}n.prototype.add=n.prototype.addReporter,n.prototype.remove=n.prototype.removeReporter,n.prototype.clear=n.prototype.removeReporter,n.prototype.withScope=n.prototype.withTag,n.prototype.mock=n.prototype.mockTypes,n.prototype.pause=n.prototype.pauseLogs,n.prototype.resume=n.prototype.resumeLogs;function H(r={}){return new n(r)}class K{constructor(t){this.options={...t},this.defaultColor="#7f8c8d",this.levelColorMap={0:"#c0392b",1:"#f39c12",3:"#00BCD4"},this.typeColorMap={success:"#2ecc71"}}_getLogFn(t){return t<1?console.__error||console.error:t===1?console.__warn||console.warn:console.__log||console.log}log(t){const e=this._getLogFn(t.level),s=t.type!=="log"?t.type:"",o=t.tag||"",c=`
      background: ${this.typeColorMap[t.type]||this.levelColorMap[t.level]||this.defaultColor};
      border-radius: 0.5em;
      color: white;
      font-weight: bold;
      padding: 2px 0.5em;
    `,u=`%c${[o,s].filter(Boolean).join(":")}`;typeof t.args[0]=="string"?e(`${u}%c ${t.args[0]}`,c,"",...t.args.slice(1)):e(u,c,...t.args)}}function Q(r={}){return H({reporters:r.reporters||[new K({})],prompt(e,s={}){return s.type==="confirm"?Promise.resolve(confirm(e)):Promise.resolve(prompt(e))},...r})}const W=Q();class X extends Error{constructor(t){super(t),this.name=this.constructor.name,typeof Error.captureStackTrace=="function"?Error.captureStackTrace(this,this.constructor):this.stack=new Error(t).stack}}function Z(r){r instanceof X&&W.error(r.message),process.exitCode=1}q().catch(Z);
